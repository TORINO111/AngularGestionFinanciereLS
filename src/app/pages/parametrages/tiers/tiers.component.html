<!-- end page title -->
<app-page-title [breadcrumbItems]="pageTitle" title="Tiers"></app-page-title>

<div class="loader-container" *ngIf="!result">
  <div class="lds-dual-ring"></div>
</div>
<!-- start page title -->
<div class="mt-2 card" *ngIf="result">
  <div class="card-body">
    
    <div *ngIf="errorMessage" class="error-message">
      <span class="error-icon">⚠️</span> {{ errorMessage }}
    </div>
  
    <div *ngIf="importResult" class="result-container">
      <div [ngClass]="{ 'success-message': importResult.success, 'error-message': !importResult.success }">
        <span class="result-icon">{{ importResult.success ? '✓' : '⚠️' }}</span>
        {{ importResult.message }}
        <span *ngIf="importResult.success"> - {{ importResult.lignesImportees }} comptes importés</span>
      </div>
    
      <table *ngIf="importResult.erreurs?.length > 0" class="error-table">
        <thead>
          <tr>
            <th>Ligne</th>
            <th>Compte</th>
            <th>Intitulé</th>
            <th>Erreur</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let err of importResult.erreurs">
            <td>{{ err.ligne }}</td>
            <td>{{ err.compte }}</td>
            <td>{{ err.intitule }}</td>
            <td>{{ err.erreur }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <br>
    <form [formGroup]="tiersForm">
      <!-- Toolbar responsive -->
      <div class="toolbar d-flex flex-wrap gap-2 mb-3">
        <button type="button" class="btn btn-success" (click)="ajouter()">Nouveau</button>
        <button type="button" class="btn btn-success" (click)="modifier()" [disabled]="selectedIndex === null">Modifier</button>
        <button type="button" class="btn btn-danger" (click)="supprimer()" [disabled]="selectedIndex === null">Supprimer</button>
        <button type="button" class="btn btn-success" (click)="enregistrer()" [disabled]="!formVisible">Enregistrer</button>
        <button type="button" class="btn btn-success" (click)="fermer()" [disabled]="!formVisible">Fermer</button>
        <button type="button" class="btn btn-success" (click)="openScrollableModal(importExcelModal)">Importer</button>
      </div>
    <!-- Modal -->
    <ng-template #importExcelModal let-modal>
      <div class="modal-header" style="background-color: #128C7E;">
        <h4 class="modal-title text-light" id="NewTaskModalLabel">IMPORT EXCEL</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('')"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="onSubmit();modal.close('Close click')" enctype="multipart/form-data" [formGroup]="modelImportForm" class="p-2">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Fichier Excel</label>
              <input required type="file" accept=".xls,.xlsx" class="form-control" (change)="onExcelFileSelected($event)">
              <div *ngIf="fileError" class="text-danger">{{ fileError }}</div>
            </div>
  
            <!-- <div class="col-md-6 mb-3">
              <label>Année</label>
              <select required name="annee" formControlName="annee" class="form-select" id="annee">
                <option value="null" disabled>---Select Année---</option>
                <option *ngFor="let annee of annees" [value]="annee">{{annee}}</option>
              </select>
            </div> -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" (click)="modal.dismiss('')">Fermer</button>
            <button type="submit" class="btn btn-secondary">Valider</button>
          </div>
        </form>
      </div>
    </ng-template>
    
      <div class="container-fluid">
        <!-- Formulaire principal -->
        <div class="row mb-3" *ngIf="formVisible">
          <div class="row" >
            <div class="col-md-2">
              <div class="form-group">
                <label for="">Type Tiers</label>
                <select required name="type" formControlName="type"  class="form-select" id="type">
                  <option  value="null" disabled>---Select Type Tiers---</option>
                  <option *ngFor="let type of types " [value]="type.id">{{type.libelle}}</option>
                </select>
               </div>
            </div>
          <div class="col-12 col-md-2 mb-2">
            <div class="form-group">
              <label for="">Compte Tiers</label>
            <input type="text" id="compte" name="compte" formControlName="compte" class="form-control" placeholder="compte">
            <strong class="text-danger" *ngIf="tiersForm.get('compte').hasError('required') && tiersForm.get('compte').touched">
              Champ obligatoire !
            </strong>
            </div>
          </div>
      
          <div class="col-12 col-md-4 mb-2">
            <div class="form-group">
              <label for="">Intitule du tiers</label>
            <input type="text" id="intitule" name="intitule" formControlName="intitule" class="form-control" placeholder="intitule">
            <strong class="text-danger" *ngIf="tiersForm.get('intitule').hasError('required') && tiersForm.get('intitule').touched">
              Champ obligatoire !
            </strong>
            </div>
          </div>

          <div class="col-12 col-md-2 mb-2">
            <div class="form-group">
              <label for="">Collectif *</label>
            <input type="text" id="compteCollectif" name="compteCollectif" formControlName="compteCollectif" class="form-control" placeholder="Compte Collectif">
            <strong class="text-danger" *ngIf="tiersForm.get('compteCollectif').hasError('required') && tiersForm.get('compteCollectif').touched">
              Champ obligatoire !
            </strong>
            </div>
          </div>
          <div class="col-12 col-md-2 mb-2">
            <div class="form-group">
              <label for="">Interlocuteur</label>
            <input type="text" id="interlocuteur" name="interlocuteur" formControlName="interlocuteur" class="form-control" placeholder="interlocuteur">
            <strong class="text-danger" *ngIf="tiersForm.get('interlocuteur').hasError('required') && tiersForm.get('interlocuteur').touched">
              Champ obligatoire !
            </strong>
            </div>
          </div>
          <div class="col-12 col-md-2 mb-2">
            <div class="form-group">
              <label for="">Tel. Interlocuteur</label>
            <input type="text" id="telephoneInterlocuteur" name="telephoneInterlocuteur" formControlName="telephoneInterlocuteur" class="form-control" placeholder="Tel. Interlocuteur">
            <strong class="text-danger" *ngIf="tiersForm.get('telephoneInterlocuteur').hasError('required') && tiersForm.get('telephoneInterlocuteur').touched">
              Champ obligatoire !
            </strong>
            </div>
          </div>
          <div class="col-12 col-md-2 mb-2">
            <div class="form-group">
              <label for="">Tel. Societe</label>
            <input type="text" id="telephoneSociete" name="telephoneSociete" formControlName="telephoneSociete" class="form-control" placeholder="Tel. Societe">
            <strong class="text-danger" *ngIf="tiersForm.get('telephoneSociete').hasError('required') && tiersForm.get('telephoneSociete').touched">
              Champ obligatoire !
            </strong>
            </div>
          </div>
          


          
        </div>
        
         </div>
      </div>
      
    </form>

      <div class="table-container">
        <table class="table table-bordered table-sm custom-table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Compte</th>
          <th>Intitulé</th>
          <th>Compte collectif</th>
          <th>Interlocuteur</th>
          <th>Tel. Interlocuteur</th>
          <th>Tel. Société</th>
        </tr>
      </thead>
      <tbody *ngIf="!isLoading">
        <tr  *ngFor="let tier of tiers; let i = index"
        (click)="selectLigne(i)"
        [class.selected]="i === selectedIndex">
          <td>{{ tier.value.type }}</td>
          <td>{{ tier.value.compte }}</td>
          <td>{{ tier.value.intitule }}</td>
          <td>{{ tier.value.compteCollectif }}</td>
          <td>{{ tier.value.interlocuteur }}</td>
          <td>{{ tier.value.telephoneInterlocuteur }}</td>
          <td>{{ tier.value.telephoneSociete }}</td>
        </tr>
        <tr *ngIf="tiers?.length == 0" >
            <td  colspan="7"><h3 style="text-align: center;">Aucune donnée trouvée</h3></td>
          </tr>
      </tbody>
      <tbody *ngIf="isLoading">
        <tr>
          <td colspan="7" class="text-center">
            <div class="spinner-border text-secondary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    </div>
 
    </div>
  </div>
